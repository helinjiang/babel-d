{"version":3,"sources":["../src/babel-compile.js"],"names":["compile","compileFile","compileByBabel","getFiles","fs","require","path","fse","fileUtil","babel","allowFileExt","compiledMtime","compiledErrorFiles","srcPath","outPath","options","debug","console","log","files","changedFiles","forEach","srcFullPath","join","file","saveOutFullPathpath","extname","indexOf","mTime","statSync","mtime","getTime","isFile","outmTime","ret","push","index","splice","saveOutFullPath","onlyCopy","content","readFileSync","copySync","startTime","Date","now","data","filename","endTime","outputFileSync","code","e","error","transform","presets","plugins","paths","result","getAllFiles","map","item","relativePath"],"mappings":"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","file":"babel-compile.js","sourcesContent":["const fs = require('fs');\nconst path = require('path');\nconst fse = require('fs-extra');\nconst fileUtil = require('./file');\n\n//babel not export default property\n//so can not use `import babel from 'babel-core'`\nconst babel = require('babel-core');\n\nlet allowFileExt = ['.js'];\n\n/**\n * store compiled files last mtime\n * @type {Object}\n */\nlet compiledMtime = {};\n\n/**\n * compiled error files\n * @type {Array}\n */\nlet compiledErrorFiles = [];\n\n/**\n * compile files\n *\n * @param {String} srcPath\n * @param {String} outPath\n * @param {Object} [options]\n * @param {String} [options.debug] only for debug\n */\nexport function compile(srcPath, outPath, options = {}) {\n  if (options.debug) {\n    console.log('\\nBegin compile...', srcPath, outPath, options);\n  }\n\n  let files = getFiles(srcPath, true);\n\n  let changedFiles = [];\n\n  if (options.debug) {\n    console.log('all files:', files);\n  }\n\n  files.forEach(file => {\n    let srcFullPath = path.join(srcPath, file);\n    let saveOutFullPathpath = path.join(outPath, file);\n    let extname = path.extname(file);\n\n    if (options.debug) {\n      console.log(`[${extname}] ${srcFullPath} => ${saveOutFullPathpath}`);\n    }\n\n    //if is not js file, only copy\n    if (allowFileExt.indexOf(extname) === -1) {\n      compileFile(srcFullPath, saveOutFullPathpath, true, options);\n      return;\n    }\n\n    let mTime = fs.statSync(srcFullPath).mtime.getTime();\n\n    if (fileUtil.isFile(saveOutFullPathpath)) {\n      let outmTime = fs.statSync(saveOutFullPathpath).mtime.getTime();\n\n      // if compiled file mtime is later than source file,\n      // it means source file not modified, so there is no necessary to compile.\n      if (outmTime >= mTime) {\n        return;\n      }\n    }\n\n    if (!compiledMtime[file] || mTime > compiledMtime[file]) {\n      let ret = compileFile(srcFullPath, saveOutFullPathpath, false, options);\n\n      if (ret) {\n        changedFiles.push(saveOutFullPathpath);\n      }\n\n      compiledMtime[file] = mTime;\n\n      let index = compiledErrorFiles.indexOf(file);\n\n      if (ret) {\n        if (index > -1) {\n          compiledErrorFiles.splice(index, 1);\n        }\n      } else if (ret === false) {\n        if (index === -1) {\n          compiledErrorFiles.push(file);\n        }\n      }\n    }\n  });\n\n  // console.error(compiledErrorFiles)\n}\n\n/**\n * compile single file\n *\n * @param {String} srcFullPath\n * @param {String} saveOutFullPath\n * @param {Boolean} [onlyCopy]\n * @param {Object} [options]\n * @param {String} [options.debug] only for debug\n */\nexport function compileFile(srcFullPath, saveOutFullPath, onlyCopy, options = {}) {\n  let content = fs.readFileSync(srcFullPath, 'utf8');\n\n  //when get file content empty, maybe file is locked\n  if (!content) {\n    return;\n  }\n\n  // only copy file content\n  if (onlyCopy) {\n    fse.copySync(srcFullPath, saveOutFullPath);\n    return;\n  }\n\n  try {\n    let startTime = Date.now();\n\n    let data = compileByBabel(content, {\n      filename: srcFullPath\n      // sourceMaps: true,\n      // sourceFileName: relativePath\n    });\n\n    let endTime = Date.now();\n\n    if (options.debug) {\n      console.log(`Compile file ${srcFullPath}`, `Babel cost ${endTime - startTime} ms`);\n    }\n\n    // save file\n    fse.outputFileSync(saveOutFullPath, data.code);\n\n    return true;\n  } catch (e) {\n    console.error(`compile file ${srcFullPath} error`, e);\n  }\n\n  return false;\n}\n\n/**\n * babel compile\n * https://babeljs.io/docs/core-packages/#babeltransformcode-string-options-object\n * @return {} []\n */\nexport function compileByBabel(content, options) {\n  return babel.transform(content, Object.assign({\n    presets: ['es2015-loose', 'stage-1'],\n    plugins: ['transform-runtime']\n  }, options));\n}\n\n/**\n * get all files\n * @param paths\n */\nexport function getFiles(paths) {\n  let result = fileUtil.getAllFiles(paths);\n\n  let files = result.map((item) => {\n    return item.relativePath;\n    // return path.join(item.basePath, item.relativePath);\n  });\n\n  return files;\n}\n"]}