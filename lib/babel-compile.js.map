{"version":3,"sources":["../src/babel-compile.js"],"names":["compile","compileFile","compileByBabel","getFiles","fs","require","path","fse","fileUtil","babel","allowFileExt","compiledMtime","compiledErrorFiles","srcPath","outPath","options","debug","console","log","files","changedFiles","forEach","srcFullPath","join","file","saveOutFullPathpath","extname","indexOf","mTime","statSync","mtime","getTime","isFile","outmTime","ret","push","index","splice","saveOutFullPath","onlyCopy","content","readFileSync","copySync","startTime","Date","now","data","filename","endTime","outputFileSync","code","e","error","transform","presets","plugins","paths","result","getAllFiles","map","item","relativePath"],"mappings":"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","file":"babel-compile.js","sourcesContent":["const fs = require('fs');\r\nconst path = require('path');\r\nconst fse = require('fs-extra');\r\nconst fileUtil = require('./file');\r\n\r\n//babel not export default property\r\n//so can not use `import babel from 'babel-core'`\r\nconst babel = require('babel-core');\r\n\r\nlet allowFileExt = ['.js'];\r\n\r\n/**\r\n * store compiled files last mtime\r\n * @type {Object}\r\n */\r\nlet compiledMtime = {};\r\n\r\n/**\r\n * compiled error files\r\n * @type {Array}\r\n */\r\nlet compiledErrorFiles = [];\r\n\r\n/**\r\n * compile files\r\n *\r\n * @param {String} srcPath\r\n * @param {String} outPath\r\n * @param {Object} [options]\r\n * @param {String} [options.debug] only for debug\r\n */\r\nexport function compile(srcPath, outPath, options = {}) {\r\n  if (options.debug) {\r\n    console.log('\\nBegin compile...', srcPath, outPath, options);\r\n  }\r\n\r\n  let files = getFiles(srcPath, true);\r\n\r\n  let changedFiles = [];\r\n\r\n  if (options.debug) {\r\n    console.log('all files:', files);\r\n  }\r\n\r\n  files.forEach(file => {\r\n    let srcFullPath = path.join(srcPath, file);\r\n    let saveOutFullPathpath = path.join(outPath, file);\r\n    let extname = path.extname(file);\r\n\r\n    if (options.debug) {\r\n      console.log(`[${extname}] ${srcFullPath} => ${saveOutFullPathpath}`);\r\n    }\r\n\r\n    //if is not js file, only copy\r\n    if (allowFileExt.indexOf(extname) === -1) {\r\n      compileFile(srcFullPath, saveOutFullPathpath, true, options);\r\n      return;\r\n    }\r\n\r\n    let mTime = fs.statSync(srcFullPath).mtime.getTime();\r\n\r\n    if (fileUtil.isFile(saveOutFullPathpath)) {\r\n      let outmTime = fs.statSync(saveOutFullPathpath).mtime.getTime();\r\n\r\n      // if compiled file mtime is later than source file,\r\n      // it means source file not modified, so there is no necessary to compile.\r\n      if (outmTime >= mTime) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    if (!compiledMtime[file] || mTime > compiledMtime[file]) {\r\n      let ret = compileFile(srcFullPath, saveOutFullPathpath, false, options);\r\n\r\n      if (ret) {\r\n        changedFiles.push(saveOutFullPathpath);\r\n      }\r\n\r\n      compiledMtime[file] = mTime;\r\n\r\n      let index = compiledErrorFiles.indexOf(file);\r\n\r\n      if (ret) {\r\n        if (index > -1) {\r\n          compiledErrorFiles.splice(index, 1);\r\n        }\r\n      } else if (ret === false) {\r\n        if (index === -1) {\r\n          compiledErrorFiles.push(file);\r\n        }\r\n      }\r\n    }\r\n  });\r\n\r\n  // console.error(compiledErrorFiles)\r\n}\r\n\r\n/**\r\n * compile single file\r\n *\r\n * @param {String} srcFullPath\r\n * @param {String} saveOutFullPath\r\n * @param {Boolean} [onlyCopy]\r\n * @param {Object} [options]\r\n * @param {String} [options.debug] only for debug\r\n */\r\nexport function compileFile(srcFullPath, saveOutFullPath, onlyCopy, options = {}) {\r\n  let content = fs.readFileSync(srcFullPath, 'utf8');\r\n\r\n  //when get file content empty, maybe file is locked\r\n  if (!content) {\r\n    return;\r\n  }\r\n\r\n  // only copy file content\r\n  if (onlyCopy) {\r\n    fse.copySync(srcFullPath, saveOutFullPath);\r\n    return;\r\n  }\r\n\r\n  try {\r\n    let startTime = Date.now();\r\n\r\n    let data = compileByBabel(content, {\r\n      filename: srcFullPath\r\n      // sourceMaps: true,\r\n      // sourceFileName: relativePath\r\n    });\r\n\r\n    let endTime = Date.now();\r\n\r\n    if (options.debug) {\r\n      console.log(`Compile file ${srcFullPath}`, `Babel cost ${endTime - startTime} ms`);\r\n    }\r\n\r\n    // save file\r\n    fse.outputFileSync(saveOutFullPath, data.code);\r\n\r\n    return true;\r\n  } catch (e) {\r\n    console.error(`compile file ${srcFullPath} error`, e);\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\n/**\r\n * babel compile\r\n * https://babeljs.io/docs/core-packages/#babeltransformcode-string-options-object\r\n * @return {} []\r\n */\r\nexport function compileByBabel(content, options) {\r\n  return babel.transform(content, Object.assign({\r\n    presets: ['es2015-loose', 'stage-1'],\r\n    plugins: ['transform-runtime']\r\n  }, options));\r\n}\r\n\r\n/**\r\n * get all files\r\n * @param paths\r\n */\r\nexport function getFiles(paths) {\r\n  let result = fileUtil.getAllFiles(paths);\r\n\r\n  let files = result.map((item) => {\r\n    return item.relativePath;\r\n    // return path.join(item.basePath, item.relativePath);\r\n  });\r\n\r\n  return files;\r\n}\r\n"]}