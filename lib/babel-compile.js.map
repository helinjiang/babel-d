{"version":3,"sources":["../src/babel-compile.js"],"names":["compile","fs","require","path","fse","fileUtil","allowFileExt","compiledMtime","compiledErrorFiles","srcPath","outPath","files","getFiles","changedFiles","console","log","forEach","srcFullPath","join","file","saveOutFullPathpath","extname","indexOf","compileFile","mTime","statSync","mtime","getTime","isFile","outmTime","ret","push","index","splice","saveOutFullPath","onlyCopy","content","readFileSync","outputFileSync","compileByBabel","e","error","startTime","Date","now","babel","data","transform","filename","presets","plugins","code","paths","result","getAllFiles","map","item","relativePath"],"mappings":"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","file":"babel-compile.js","sourcesContent":["const fs = require('fs');\nconst path = require('path');\nconst fse = require('fs-extra');\nconst fileUtil = require('./file');\n\nlet allowFileExt = ['.js'];\n\n/**\n * store compiled files last mtime\n * @type {Object}\n */\nlet compiledMtime = {};\n\n/**\n * compiled error files\n * @type {Array}\n */\nlet compiledErrorFiles = [];\n\n/**\n * compile\n * @return {} []\n */\nexport function compile(srcPath, outPath) {\n    let files = getFiles(srcPath, true);\n\n    let changedFiles = [];\n\n    console.log(files);\n\n    files.forEach(file => {\n        let srcFullPath = path.join(srcPath, file);\n        let saveOutFullPathpath = path.join(outPath, file);\n\n        let extname = path.extname(file);\n\n        //if is not js file, only copy\n        if (allowFileExt.indexOf(extname) === -1) {\n            compileFile(srcFullPath, saveOutFullPathpath, true);\n            return;\n        }\n\n        let mTime = fs.statSync(srcFullPath).mtime.getTime();\n\n        if (fileUtil.isFile(saveOutFullPathpath)) {\n            let outmTime = fs.statSync(saveOutFullPathpath).mtime.getTime();\n\n            // if compiled file mtime is later than source file,\n            // it means source file not modified, so there is no necessary to compile.\n            if (outmTime >= mTime) {\n                return;\n            }\n        }\n\n        if (!compiledMtime[file] || mTime > compiledMtime[file]) {\n            let ret = compileFile(srcFullPath, saveOutFullPathpath);\n\n            if (ret) {\n                changedFiles.push(saveOutFullPathpath);\n            }\n\n            compiledMtime[file] = mTime;\n\n            let index = compiledErrorFiles.indexOf(file);\n\n            if (ret) {\n                if (index > -1) {\n                    compiledErrorFiles.splice(index, 1);\n                }\n            } else if (ret === false) {\n                if (index === -1) {\n                    compiledErrorFiles.push(file);\n                }\n            }\n        }\n    });\n\n    // console.error(compiledErrorFiles)\n}\n\n/**\n * compile single file\n * @param  {String} file     []\n * @param  {Boolean} [onlyCopy] []\n * @return {}          []\n */\nfunction compileFile(srcFullPath, saveOutFullPath, onlyCopy) {\n    let content = fs.readFileSync(srcFullPath, 'utf8');\n\n    //when get file content empty, maybe file is locked\n    if (!content) {\n        return;\n    }\n\n    // only copy file content\n    if (onlyCopy) {\n        fse.outputFileSync(saveOutFullPath, content);\n        return;\n    }\n\n    try {\n        compileByBabel(content, srcFullPath, saveOutFullPath);\n        return true;\n    } catch (e) {\n        console.error(`compile file ${srcFullPath} error`, e);\n    }\n\n    return false;\n}\n\n/**\n * babel compile\n * @return {} []\n */\nfunction compileByBabel(content, srcFullPath, saveOutFullPath) {\n    let startTime = Date.now();\n\n    //babel not export default property\n    //so can not use `import babel from 'babel-core'`\n    let babel = require('babel-core');\n    let data = babel.transform(content, {\n        filename: srcFullPath,\n        presets: ['es2015-loose', 'stage-1'],\n        plugins: ['transform-runtime'],\n        // sourceMaps: true,\n        // sourceFileName: relativePath\n    });\n\n    console.log(`Compile file ${srcFullPath}`, 'Babel', startTime);\n\n    fse.outputFileSync(saveOutFullPath, data.code);\n}\n\nfunction getFiles(paths) {\n    let files = [];\n\n    let result = fileUtil.getAllFiles(paths);\n\n    files = result.map((item) => {\n        return item.relativePath;\n        // return path.join(item.basePath, item.relativePath);\n    });\n\n    return files;\n}\n"]}